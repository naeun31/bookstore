<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>도서통합검색</title>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/xeicon@2.3.3/xeicon.min.css">
    <link rel="stylesheet" href="../lib/bootstrap-4.2.1/css/bootstrap.css">
    <link rel="stylesheet" href="../css/style.css">
    <script src="../lib/bootstrap-4.2.1/js/jquery-3.5.1.min.js"></script>
</head>
<body>
    <div class="wrap">
        <div class="search-wrap">
            <h2><i class="xi-book"></i> 도서검색</h2>
            <div class="search-box">
                <input type="text" id="q">
                <button id="btn-search"><i class="xi-search"></i></button>
            </div>
            <div class="row justify-content-center">
                <div class="col-lg-8 col-md-12">
                    <div class="search-result"><b>'강아지'</b> 검색 결과 총 <span>40</span>건</div>
                    <ul class="search-list main" id="book-list">
                    </ul>
                    <ul class="pagination">
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <a class="admin btn btn-secondary" href="./admin.html">admin</a>

    <style>
    </style>
    <script>
        function App() {
            App.page = 1;
            $(document).on("click", "#btn-search", function(e) {
                searchList();
            });
            $(document).on("click", ".pagination li", function(e) {
                searchList();
            });
            $("#q").on("keypress", function(e){
                if(e.key !== "Enter") {
                    return;
                }
                searchList();
            })
            const searchList = function() {
                $(".search-wrap").addClass("result")
                $.ajax({
                    url:'/api/search',
                    type:'GET',
                    data:{'q':$("#q").val().toLowerCase()},
                    success:function(data){
                        console.log(data)
                        $(".search-wrap .row").addClass("result");
                        $('.search-result b').text(data['keyword']);
                        $('.search-result span').text(data['total']);
                        if(data['result'].length == 0){
                            template(undefined, $("#book-list"));
                        }else{
                            template(data['result'], $("#book-list"));
                            pagination(data['total'], App.page, $('.pagination'));
                        }

                        if(!data['keyword']) {
                            $('.search-result b').text('전체');
                        }
                    }
                });
            }
            const template = function(items, el) {
                let $li;
                $(el).empty();
                if(items==undefined){
                    $li = `
                        <li>
                            <div class="no-data text-center">검색결과가 없습니다.</div>
                        </li>`
                    $(el).append($li);
                }else{
                    for (item of items) {
                        $li = `
                            <li class="tbl tbody" data-key=${item.barcode}>
                                <div><img src="${item.image}"></div>
                                <div>
                                    <h3>${item.title}</h3>
                                    <span>${item.author}</span>
                                    <span>${item.publish}</span>
                                    <span>${item.published_date}</span>
                                    <h5>${item.price}</h5>
                                    <h4>도서위치 : ${item.num}</h4>
                                </div>
                            </li>`
                        $(el).append($li);
                    }
                }
            }
            const pagination = function(total, page, el) {
                const limit = 5;
                const totalPage = Math.ceil(total / limit);
                let currentPage = page;
                const first = currentPage - (currentPage % limit) + 1;
                let last = currentPage - (currentPage % limit) + limit;
                if (last > totalPage) {
                    last = totalPage;
                }
                // console.log(totalPage, currentPage, first, last)
                let $li;
                $(el).empty();
                for (let i = first; i <= last; i++) {
                    if(i == currentPage) {
                        $li = `
                        <li class="current" data-page=${i}>
                            <a href="javascript:void(0)">${i}</a>
                        </li>`
                    } else {
                        $li = `
                        <li data-page=${i}>
                            <a href="javascript:void(0)">${i}</a>
                        </li>`
                    }
                    $(el).append($li);
                }
            }
        }
        const app = new App();

    </script>
</body>
</html>